name: Build & Deploy to Fasthosts

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build artifact (zip for record)
        run: |
          zip -r site.zip . -x "**/.git/**" "**/.github/**" "**/node_modules/**"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-zip
          path: site.zip
          retention-days: 7

      - name: FTP Deploy to /htdocs
        uses: SamKirkland/FTP-Deploy-Action@v4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          server-dir: ${{ secrets.FTP_PATH }}/
          local-dir: .
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            site.zip

      - name: Remote install / migrate / health
        env:
          SITE_URL:   ${{ secrets.SITE_URL }}           # e.g. https://aurorabp.co.uk
          API_TOKEN:  ${{ secrets.API_TOKEN }}          # strong random token
          DB_HOST:    ${{ secrets.DB_HOST }}
          DB_NAME:    ${{ secrets.DB_NAME }}
          DB_USER:    ${{ secrets.DB_USER }}
          DB_PASS:    ${{ secrets.DB_PASS }}
        run: |
          set -e
          curl -fsS -X POST "$SITE_URL/api/install.php" \
            -d token="$API_TOKEN" \
            -d db_host="$DB_HOST" -d db_name="$DB_NAME" -d db_user="$DB_USER" -d db_pass="$DB_PASS"
          curl -fsS -X POST "$SITE_URL/api/migrate_json.php" -d token="$API_TOKEN"
          curl -fsS "$SITE_URL/api/health.php"
